---
title: cache
date: 2022-06-13 18:14:43
tags:
  - cache
  - cdn
  - 浏览器缓存
categories:
  - 缓存
---


### 缓存的一些知识点

缓存在前端领域是不可或缺的一部分，在实际的工作中也会经常遇到下面的场景

> 明明最新的文件我在服务器上面已经更新了，但是为啥客户端访问的资源文件还是旧的

我在部署hexo博客的过程中，就遇到了这个问题。因为我的资源文件是部署在oss中的，同时对该bucket也配置了cdn加速和cdn缓存自动刷新的设置。但是当我重新部署后，通过浏览器访问静态资源文件，依然是旧的。

其实问题出现在了客户端缓存中，这里的客户端，对于前端来说，就是浏览器

<!-- more -->

### 浏览器缓存

浏览器缓存分为协商缓存和强缓存，强缓存的优先级高于协商缓存

1.**强缓存**：浏览器在加载资源时，首先会先根据首部信息（Expires和Cache-Control）来判断是否命中强缓存，如果命中，直接从浏览器缓存中将资源取出来，不会发送请求到服务器。

强缓存一般主要用两个字段来进行控制`cache-control` `expires`

比如：
```javascript
 cache-control: max-age="3600" // 服务器响应客户端第一次请求时，会明确的告诉客户端（浏览器），在一个小时之内（3600秒），再次访问该资源，直接用缓存即可
```

打开控制台`network`模块，查看`size`这一列，看到字眼形如`from disk cache` `from memory cache`的，表示命中了强缓存，此时的响应状态码为`200`

2.**协商缓存**：在没有命中强缓存的前提下，浏览器会发送一个请求（带有一些跟协商缓存有关的首部）给服务器，服务器根据这些首部信息和所请求资源目前的一些 header 信息来比较验证这个资源是否命中协商缓存，如果命中了，服务器会将这个请求返回，但是并不会返回这个资源的数据，而是告诉浏览器，资源没有变化，可以直接从浏览器缓存中加载这个资源。

协商缓存一般会在请求头中以下列字眼标识

```javascript
  cache-control: no-cache
```

当命中协商缓存的时候，服务器在第一次响应时，在响应头上加上资源文件的最后修改时间`Last-Modified`或者是强标识符`ETag`
```javascript
Last-Modified: Mon, 8 Oct 2021 06:35:57 GMT // 表示该文件的最后修改时间是Mon, 8 Oct 2021 06:35:57 GMT
```

客户端再次请求的时候，会在请求头中加上这样的字段

```javascript
If-Modified-Since: Mon, 8 Oct 2021 06:35:57 GMT 
````
询问服务端，该资源在Mon, 8 Oct 2021 06:35:57 GMT 之后是否修改过，如果修改的话，就返回最新的资源，并在响应头上加伤最新的`Last-Modified`。如果在这之后并没有修改过该文件的话，那么直接返回状态码`304`，明确告知浏览器去缓存里面拿内容即可


`Etag`的作用和`Last-Modified`差不多，只不过更加准确而已





